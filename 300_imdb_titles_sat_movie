INSERT INTO 300_imdb_titles_sat_movie
SELECT A.* 
FROM (
	SELECT DISTINCT
		MD5(CONCAT(
			COALESCE(TRIM(UPPER(originalTitle)),''), '|',
			COALESCE(TRIM(UPPER(startYear)),'')
		)) 300_IMDB_TITLES_HUB_MOVIE_HKEY,
		0 BATCH_ID,
		LOAD_DATETIME,
		NULL LOAD_END_DATETIME,
		RECORD_SOURCE,
		MD5(CONCAT(
			COALESCE(runtimeMinutes, '')
		)) HASH_DIFF,
		runtimeMinutes
	FROM pandora.200_tximdb_title_basics
) A
LEFT JOIN 300_imdb_titles_sat_movie B ON (
	B.300_IMDB_TITLES_HUB_MOVIE_HKEY = A.300_IMDB_TITLES_HUB_MOVIE_HKEY
	AND B.LOAD_END_DATETIME IS NULL
)
WHERE
A.LOAD_DATETIME = '${LOAD_DATETIME}'
AND A.HASH_DIFF <> COALESCE(B.HASH_DIFF, '')
;

UPDATE 300_imdb_titles_sat_movie
SET LOAD_END_DATETIME = (
	SELECT DATE_ADD(MAX(LOAD_DATETIME), INTERVAL -1 MICROSECOND)
	FROM 300_imdb_titles_sat_movie B
	WHERE 300_imdb_titles_sat_movie.300_IMDB_TITLES_HUB_MOVIE_HKEY =
		B.300_IMDB_TITLES_HUB_MOVIE_HKEY
	AND B.LOAD_DATETIME > 300_imdb_titles_sat_movie.LOAD_DATETIME
)
WHERE LOAD_END_DATETIME IS NULL
